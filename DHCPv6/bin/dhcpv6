#!/bin/sh

NAME="Jagornet DHCPv6 Server"

OP=$1
# shift causes all arguments to be moved left by one
# which essentially removes this wrapper script's argument
shift
#echo "$@"
DHCPV6_OPTS="$@"

if [ -n "$JAVA_HOME" ] ; then
  JAVA="$JAVA_HOME/bin/java"
else
  if [ -x /usr/bin/java ] ; then
    JAVA=/usr/bin/java
  else
    echo "Error - Java not found.  Please set JAVA_HOME environment variable."
    exit 1
  fi
fi

# This block of shell script for determining the
# application's home directory was borrowed from 
# the Apache ActiveMQ server startup script.
if [ -z "$DHCPV6_HOME" ] ; then
  # try to find DHCPV6
  if [ -d /opt/jagornet/dhcpv6 ] ; then
    DHCPV6_HOME=/opt/jagornet/dhcpv6
  fi

  if [ -d "${HOME}/opt/jagornet/dhcpv6" ] ; then
    DHCPV6_HOME="${HOME}/opt/jagornet/dhcpv6"
  fi

  ## resolve links - $0 may be a link dhcpv6's home
  PRG="$0"
  progname=`basename "$0"`
  saveddir=`pwd`

  # need this for relative symlinks
  dirname_prg=`dirname "$PRG"`
  cd "$dirname_prg"

  while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '.*/.*' > /dev/null; then
    PRG="$link"
    else
    PRG=`dirname "$PRG"`"/$link"
    fi
  done

  DHCPV6_HOME=`dirname "$PRG"`/..

  cd "$saveddir"

  # make it fully qualified
  DHCPV6_HOME=`cd "$DHCPV6_HOME" && pwd`
fi

# Add the config directory to the beginning of the CLASSPATH
# so that the server can find the log4j.properties file
DHCPV6_CLASSPATH="$DHCPV6_HOME/conf"

# Add all .jar files in DHCPV6_HOME/lib/ to the CLASSPATH
# This trick courtesy of http://www.rgagnon.com/javadetails/java-0587.html 
DHCPV6_CLASSPATH="$DHCPV6_CLASSPATH:$DHCPV6_HOME/lib/*"

CLASSPATH=$CLASSPATH:$DHCPV6_CLASSPATH; export CLASSPATH

# The "main" Java class for the DHCPv6 Server
DHCPV6_MAIN="com.jagornet.dhcpv6.server.DhcpV6Server"

# The "main" Java class for the DHCPv6 Test Client
DHCPV6TESTCLIENT_MAIN="com.jagornet.dhcpv6.client.ClientSimulator"
DHCPV4TESTCLIENT_MAIN="com.jagornet.dhcpv6.client.ClientSimulatorV4"

# Note: log4j.configuration property references a file in the classpath (see above)
#       the default is shown, change only if necessary
#LOG4J="-Dlog4j.configuration=log4j.properties"

# The Jagornet DHCPv6 server supports Java Management Extensions (JMX)
# for managing logging parameters and monitoring server statistics.
# Sun's JRE 6 provides out-of-the-box support for JMX as described at
# http://java.sun.com/javase/6/docs/technotes/guides/management/agent.html.
	 
JAVA_OPTS="-server $LOG4J $JMX"

DHCPV6_PID="$DHCPV6_HOME/dhcpv6server.pid"

isRunning() {

	if [ -f "$DHCPV6_PID" ]; then
	   ps -p `cat $DHCPV6_PID` > /dev/null 2>&1
	   if [ $? -eq 0 ]; then
	      return 1;
	   fi
	fi
	return 0;
}

start() {

	isRunning
	if [ "$?" -eq "1" ]; then
		echo "$NAME already running."
	else
		echo "Starting $NAME..."
		$JAVA $JAVA_OPTS -Ddhcpv6.home="$DHCPV6_HOME" \
						 $DHCPV6_MAIN $DHCPV6_OPTS & 
		echo "$!" > $DHCPV6_PID
		sleep 5
		isRunning
		if [ "$?" -eq "1" ]; then
			echo "$NAME started."
		else
		   echo "Failed to start $NAME."
		fi
	fi
}

stop() {

	isRunning
	if [ "$?" -eq "0" ]; then
		echo "$NAME is not running."
	else
		if [ -f "$DHCPV6_PID" ]; then
		   echo "Stopping $NAME..."
		   kill `cat $DHCPV6_PID` 2>&1
		   sleep 3
		   isRunning
		   if [ "$?" -eq "0" ]; then
			  echo "$NAME stopped."
		      rm -f $DHCPV6_PID
		   else
		      echo "Failed to stop $NAME."
		   fi
		fi
	fi
}

status() {
	isRunning
	if [ "$?" -eq "1" ]; then
		echo "$NAME is running."
	else
		echo "$NAME is not running."
	fi
}

version() {
	$JAVA $DHCPV6_MAIN -version
}

testconfigfile() {
	$JAVA $DHCPV6_MAIN --test-configfile $DHCPV6_OPTS
}

listinterfaces() {
	$JAVA $DHCPV6_MAIN --list-interfaces
}

testclient() {
	echo "Running TestClient..."
	$JAVA -Ddhcpv6.home="$DHCPV6_HOME" -Dlog4j.configuration="testclient_log4j.properties" $DHCPV6TESTCLIENT_MAIN $DHCPV6_OPTS 
}

testclient() {
	echo "Running TestClientV4..."
	$JAVA -Ddhcpv6.home="$DHCPV6_HOME" -Dlog4j.configuration="testclient_log4j.properties" $DHCPV4TESTCLIENT_MAIN $DHCPV6_OPTS 
}


case "$OP" in
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		sleep 2
		start
		;;
	status)
		status
		;;
	version)
		version
		;;
	test-configfile)
		testconfigfile
		;;
	list-interfaces)
		listinterfaces
		;;
	testclient)
		testclient
		;;
	testclientv4)
		testclient
		;;
	*)
		echo "Usage: $0 { start [options] |\n stop |\n restart [options] |\n status |\n version |\n test-configfile <configfile> |\n list-interfaces |\n testclient [options] |\n testclientv4 [options] }"
		exit 1
		;;
esac
exit 0
